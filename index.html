<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Make a Wish</title>

<style>
html,body{
  margin:0;
  height:100%;
  background:radial-gradient(circle at top,#ffe6f2,#ffc1dd);
  font-family:"Comic Sans MS", cursive;
  overflow:hidden;
}

#app{
  height:100%;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
}

/* TEXT */
#wishText{
  font-size:40px;
  color:#ff3f9e;
  margin-bottom:25px;
  text-shadow:0 6px 14px rgba(255,80,160,.45);
  user-select:none;
  position:relative;
}

/* CAKE */
#cake{
  position:relative;
  width:340px;
  height:260px;
  filter:drop-shadow(0 40px 35px rgba(0,0,0,.35));
}

/* PLATE */
#plate{
  position:absolute;
  bottom:-25px;
  left:50%;
  transform:translateX(-50%);
  width:380px;
  height:70px;
  background:radial-gradient(circle,#fff,#ddd);
  border-radius:50%;
}

/* TOP */
.layer-top{
  position:absolute;
  bottom:140px;
  width:100%;
  height:85px;
  background:linear-gradient(#fff5fb,#ff9fd1);
  border-radius:70px 70px 40px 40px;
}

/* DRIPS */
.drip{
  position:absolute;
  top:85px;
  width:26px;
  background:linear-gradient(#ff9fd1,#ff6fb8);
  border-radius:0 0 20px 20px;
}
.drip:nth-child(2){left:35px;height:55px;}
.drip:nth-child(3){left:95px;height:70px;}
.drip:nth-child(4){left:165px;height:52px;}
.drip:nth-child(5){left:230px;height:78px;}
.drip:nth-child(6){left:285px;height:60px;}

/* BODY */
.layer-bottom{
  position:absolute;
  bottom:0;
  width:100%;
  height:155px;
  background:linear-gradient(#ffbde3,#ff78bb);
  border-radius:0 0 75px 75px;
}

/* TEXT */
#cakeText{
  position:absolute;
  bottom:70px;
  width:100%;
  text-align:center;
  font-size:34px;
  color:white;
  text-shadow:0 4px 8px rgba(0,0,0,.4);
}

/* CANDLES */
#candles{
  position:absolute;
  bottom:165px;
  width:100%;
  display:flex;
  justify-content:center;
  gap:40px;
}

.candle{
  position:relative;
  width:18px;
  height:72px;
  background:repeating-linear-gradient(
    45deg,#fff,#fff 6px,#ffd2ea 6px,#ffd2ea 12px
  );
  border-radius:8px;
}

.wick{
  position:absolute;
  top:-10px;
  left:50%;
  transform:translateX(-50%);
  width:3px;
  height:12px;
  background:#222;
  border-radius:2px;
}

/* FLAME */
.flame{
  position:absolute;
  top:-52px;
  left:50%;
  transform:translateX(-50%);
  width:28px;
  height:46px;
  background:
    radial-gradient(circle at 30% 30%,
    #fffde1,#ffd76a,#ff9c00,#ff4500);
  border-radius:50% 50% 60% 60%;
  filter:drop-shadow(0 0 30px rgba(255,170,40,1));
  animation:flicker 0.9s infinite ease-in-out;
}

@keyframes flicker{
  0%{transform:translateX(-50%) scale(1) rotate(-1deg);}
  50%{transform:translateX(-50%) scale(1.08) rotate(1deg);}
  100%{transform:translateX(-50%) scale(1) rotate(-1deg);}
}

/* BLUE EMBER */
.ember{
  position:absolute;
  top:-16px;
  left:50%;
  transform:translateX(-50%);
  width:8px;
  height:8px;
  background:radial-gradient(circle,#9ff,#0066ff);
  border-radius:50%;
  filter:blur(1px);
  opacity:0;
}

/* SMOKE */
.smoke{
  position:absolute;
  width:18px;
  height:18px;
  background:rgba(200,200,200,.5);
  border-radius:50%;
  filter:blur(6px);
  pointer-events:none;
}

/* PIXEL EXPLOSION */
.pixel{
  position:absolute;
  width:6px;
  height:6px;
  height:6px;
  background:#ff4fa3;
  pointer-events:none;
}

/* HEART */
#heartBtn{
  margin-top:35px;
  font-size:44px;
  background:none;
  border:none;
  cursor:pointer;
}
</style>
</head>

<body>
<div id="app">
  <div id="wishText">make a wish</div>

  <div id="cake">
    <div class="layer-top"></div>
    <div class="drip"></div><div class="drip"></div>
    <div class="drip"></div><div class="drip"></div><div class="drip"></div>

    <div id="candles">
      <div class="candle">
        <div class="wick"></div>
        <div class="flame"></div>
        <div class="ember"></div>
      </div>
      <div class="candle">
        <div class="wick"></div>
        <div class="flame"></div>
        <div class="ember"></div>
      </div>
      <div class="candle">
        <div class="wick"></div>
        <div class="flame"></div>
        <div class="ember"></div>
      </div>
    </div>

    <div class="layer-bottom"></div>
    <div id="cakeText">happy birthday</div>
    <div id="plate"></div>
  </div>

  <button id="heartBtn">‚ù§</button>
</div>

<audio id="song" src="test.mp3"></audio>

<script>
const flames=[...document.querySelectorAll(".flame")];
const embers=[...document.querySelectorAll(".ember")];
const heartBtn=document.getElementById("heartBtn");
const song=document.getElementById("song");
const wishText=document.getElementById("wishText");

heartBtn.onclick=()=>song.play();

/* MIC BLOW DETECTION */
let blowPower=0,blown=false;

async function mic(){
  const stream=await navigator.mediaDevices.getUserMedia({audio:true});
  const ctx=new AudioContext();
  const src=ctx.createMediaStreamSource(stream);
  const analyser=ctx.createAnalyser();
  analyser.fftSize=1024;
  src.connect(analyser);
  const data=new Uint8Array(analyser.fftSize);

  let hold=0;

  function loop(){
    analyser.getByteTimeDomainData(data);
    let sum=0;
    for(let i=0;i<data.length;i++){
      let v=(data[i]-128)/128;
      sum+=v*v;
    }
    let rms=Math.sqrt(sum/data.length);
    blowPower=blowPower*0.9 + rms*0.1;

    if(blowPower>0.03) hold++; else hold=Math.max(0,hold-1);

    if(hold>35 && !blown){
      blown=true;
      extinguish();
    }
    requestAnimationFrame(loop);
  }
  loop();
}

function extinguish(){
  flames.forEach(f=>{
    f.style.transition="all .4s";
    f.style.transform+=" scale(0)";
    setTimeout(()=>f.remove(),350);
  });

  embers.forEach(e=>{
    e.style.opacity=1;
    setTimeout(()=>e.style.opacity=0,2000);
  });

  smoke();
  explodeText();
}

function smoke(){
  embers.forEach(e=>{
    let x=e.getBoundingClientRect().left;
    let y=e.getBoundingClientRect().top;
    for(let i=0;i<12;i++){
      let s=document.createElement("div");
      s.className="smoke";
      s.style.left=x+"px";
      s.style.top=y+"px";
      document.body.appendChild(s);
      let dx=(Math.random()-.5)*2;
      let dy=-Math.random()*2-1;
      let o=1;
      (function anim(){
        o-=.02;
        y+=dy;
        x+=dx;
        s.style.left=x+"px";
        s.style.top=y+"px";
        s.style.opacity=o;
        o>0?requestAnimationFrame(anim):s.remove();
      })();
    }
  });
}

function explodeText(){
  const r=wishText.getBoundingClientRect();
  wishText.style.visibility="hidden";
  for(let i=0;i<150;i++){
    const p=document.createElement("div");
    p.className="pixel";
    p.style.left=r.left + Math.random()*r.width + "px";
    p.style.top=r.top + Math.random()*r.height + "px";
    document.body.appendChild(p);
    let a=Math.random()*Math.PI*2;
    let s=Math.random()*6+2;
    let x=0,y=0,o=1;
    (function anim(){
      x+=Math.cos(a)*s;
      y+=Math.sin(a)*s;
      o-=.02;
      p.style.transform=`translate(${x}px,${y}px)`;
      p.style.opacity=o;
      o>0?requestAnimationFrame(anim):p.remove();
    })();
  }
}

mic();
</script>
</body>
</html>
